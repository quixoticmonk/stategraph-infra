# StateGraph AWS Infrastructure

Terraform configuration that deploys StateGraph on AWS using ECS EC2 and RDS PostgreSQL.

## Architecture

- **ECS EC2**: Runs the StateGraph container (`ghcr.io/stategraph/stategraph-server`) on EC2 instances
- **CloudFront**: CDN for HTTPS termination and global distribution
- **Application Load Balancer**: Routes traffic to ECS tasks
- **RDS PostgreSQL 17**: Database for state storage and transaction history
- **VPC**: Isolated network with public/private subnets
- **Secrets Manager**: Secure storage for database password and OAuth secrets

## Prerequisites

1. **AWS CLI** configured with appropriate permissions
2. **Terraform** >= 1.0
3. **Domain name** (optional, can use CloudFront domain)

## Quick Start

1. **Deploy**:
   ```bash
   terraform init
   terraform plan
   terraform apply
   ```

2. **Access StateGraph**:
   - Use the `stategraph_url` output value
   - Or configure DNS to point your domain to the load balancer

## Usage

### Basic Configuration

Create a `terraform.tfvars` file:

```hcl
aws_region         = "us-east-1"
domain_name        = "stategraph.example.com"
ecs_desired_count  = 2
stategraph_version = "latest"

cognito_users = [
  {
    username = "admin@example.com"
    email    = "admin@example.com"
  }
]

tags = {
  Environment = "production"
  Project     = "stategraph"
}
```

### Custom Database Configuration

```hcl
# terraform.tfvars

aws_region = "us-east-1"

# Database configuration
db_instance_class = "db.t3.small"
db_password       = "your-secure-password"

# Enable backup
backup_retention_period = 7
backup_window          = "03:00-04:00"
maintenance_window     = "sun:04:00-sun:05:00"
```

### Production Configuration with Encryption

```hcl
# terraform.tfvars

aws_region = "us-east-1"

# Production settings
ecs_desired_count = 3
db_instance_class = "db.r6g.large"

# Enable encryption
db_storage_encrypted = true
db_kms_key_id       = "arn:aws:kms:us-east-1:123456789012:key/abcd1234-ab12-cd34-ef56-abcdef123456"

tags = {
  Environment = "production"
  Project     = "stategraph"
  Owner       = "platform-team"
}
```

## Configuration

### Environment Variables

The deployment automatically configures these environment variables:

**Required:**
- `STATEGRAPH_UI_BASE`: Public URL for StateGraph
- `DB_HOST`, `DB_USER`, `DB_PASS`, `DB_NAME`: Database connection

**Server Configuration:**
- `STATEGRAPH_PORT`: Internal server port (8180)
- `DB_CONNECT_TIMEOUT`: Database connection timeout (120s)
- `DB_MAX_POOL_SIZE`: Max database connections (100)
- `DB_IDLE_TX_TIMEOUT`: Idle transaction timeout (180s)
- `STATEGRAPH_DB_STATEMENT_TIMEOUT`: Query timeout (1s)

**Logging & Performance:**
- `STATEGRAPH_ACCESS_LOG`: Access logging (/dev/stdout)
- `STATEGRAPH_CLIENT_MAX_BODY_SIZE`: Max request size (512m)

**OAuth Configuration:**
- `STATEGRAPH_OAUTH_TYPE`: OAuth provider (oidc)
- `STATEGRAPH_OAUTH_OIDC_ISSUER_URL`: OIDC issuer URL (Cognito)
- `STATEGRAPH_OAUTH_CLIENT_ID`: OAuth client ID (Cognito)
- `STATEGRAPH_OAUTH_CLIENT_SECRET`: OAuth client secret (Cognito)
- `STATEGRAPH_OAUTH_DISPLAY_NAME`: Login button text
- `STATEGRAPH_OAUTH_REDIRECT_BASE`: OAuth callback base URL

For a complete list of environment variables, see: https://stategraph.com/docs/reference/environment-variables

## StateGraph Image References

- **Main Image**: `ghcr.io/stategraph/stategraph-server:latest`

## Post-Deployment

1. **Access StateGraph**:
   ```bash
   # Get the HTTPS URL (via CloudFront)
   terraform output stategraph_url
   
   # Or get the direct ALB URL (HTTP only)
   terraform output stategraph_alb_url
   ```

2. **DNS Setup** (if using custom domain):
   ```bash
   # Get load balancer details
   terraform output load_balancer_dns
   terraform output load_balancer_zone_id
   
   # Create CNAME or ALIAS record pointing to the load balancer
   ```

3. **Authentication Setup**:
   ```bash
   # Get Cognito configuration details
   terraform output cognito_user_pool_id
   terraform output cognito_client_id
   terraform output cognito_login_url
   ```

## Scaling

- **Horizontal**: Increase `ecs_desired_count`
- **Vertical**: Increase EC2 instance type in launch template
- **Database**: Upgrade `db_instance_class`

## Cleanup

```bash
terraform destroy
```

## Troubleshooting

### Common Issues

1. **Database Connection Issues**
   - **Check**: Verify security groups allow port 5432 between ECS and RDS
   - **Check**: Confirm RDS instance is in "available" state
   - **Check**: Validate database credentials in Secrets Manager

2. **OAuth Configuration**
   - **Setup**: Authentication is handled by AWS Cognito
   - **Users**: Configure users via the `cognito_users` variable
   - **Login URL**: Use the `cognito_login_url` output value
   - **Documentation**: See [StateGraph OAuth docs](https://stategraph.com/docs/authentication/oauth)

3. **Load Balancer Health Checks**
   - **Check**: Target group health in AWS Console
   - **Port**: Ensure health checks target the correct container port (8080)
   - **Path**: Health check endpoint is `/api/v1/health`

### Monitoring

- **CloudWatch Logs**: `/ecs/stategraph`
- **ECS Service Events**: Check service events for deployment issues
- **Target Group Health**: Monitor ALB target group for unhealthy targets
